# ISUCON11 予選当日マニュアル

**本マニュアルならびに、[ISUCON11 予選レギュレーション](https://isucon.net/archives/55854734.html) をご確認ください。**
**本マニュアルとレギュレーションの内容に矛盾がある場合、本マニュアルの内容が優先されます**

## スケジュール

- 10:00 競技開始
- 17:00 ポータルサイト リーダーボードの更新停止
- 18:00 競技終了
- 以降、主催者により結果チェック、追試

## 課題アプリケーション ISUCONDITION について

### 課題アプリケーション仕様

課題アプリケーション ISUCONDITION の仕様については、[ISUCONDITION アプリケーションマニュアル](./isucondition.md)を参照してください。

## ISUCON11 予選 ポータルサイト

ISUCON11 予選競技は下記ポータルサイトを利用します。
事前に登録した情報を用いてログインしてください。
なお、このページは競技開始時刻までアクセスすることはできません。

ポータルサイトでは、負荷走行（ベンチマーク）の実行・結果確認、質問/サポート依頼の送信、リーダーボードの確認ができます。

https://portal.isucon.net/contestant

### リーダーボードの更新について

ポータルサイト上のリーダーボードのスコアは、競技終了前の 1 時間は他チームのスコアが更新されなくなり、自チームのスコアのみ確認が可能になります。

### Discord の利用について

ISUCON11 サポート Discord サーバーは競技中ならびにその前後の時間はすべてのチャンネルが発言不可となります。
競技時間中はポータルサイトを通して質問やサポート依頼を送信することができますので、そちらを利用してください。

ただし、予選参加者（以下選手）は競技時間中も Discord の確認が可能な状態、通知が受け取れる状態を維持してください。
これはポータルで送信した質問/サポート依頼の内容を主催者が確認した上で、リアルタイムでのチャットが必要だと判断した場合、主催者が Discord 上でプライベートチャンネルを作成し、メンション の上よびかけを行う場合があるためです。よびかけに応じない場合、主催者から質問・サポート依頼への回答ができないことに留意してください。

また、主催者からのアナウンス等も Discord で実施されます。

### 質問について

選手は主催者へ質問を送信することができます。質問は競技内容・マニュアル・レギュレーション等に対する疑問点・明確にしたい事項の確認や、サーバー障害などのトラブル報告・サポート依頼に利用することができますが、これに限りません。ただし、事前にお知らせしているように、競技時間中 AWS クーポンの適用についての質問・サポートは対象外となります。

主催者は質問された内容について競技の一環である場合は、回答できない旨を返答することがあります。

競技時間中の質問について、主催者からの回答は全選手へ公開、あるいは個別に回答されます。全選手へ公開される場合、質問内容の原文、あるいは主催者による内容の要約が公開されます。未回答の質問・未公開の回答については質問した選手およびそのチームメンバー、主催者のみが確認できます。質問への回答/更新はポータル上にて選手およびそのチームへ通知されます。

主催者は競技時間中の質問への回答について、原則として全選手へ公開します。ただし、重複する質問や、選手およびチーム個別の問題 (サーバー障害など) に対する対応の場合、この限りではありません。


## サーバー、ネットワーク構成について

予選では各チームで用意した AWS アカウントで競技環境を下記の手順に従って構築し、競技に参加します。

### 1. テンプレートのダウンロード

（TODO:ポータルとkanataくんに確認する）

環境構築には AWS CloudFormation を利用するため、ポータルサイト上から AWS CloudFormation のテンプレートのダウンロードを行います。
テンプレートはチームごとに固有のものとなっているため**共有厳禁**です。

このテンプレートでは以下のリソースを作成します。

- EC2 インスタンス (c5.large) x 3
- EBS (gp3 20GB) x 3
- VPC および VPC 関連リソース
- EIP
- インターネットゲートウェイ
- セキュリティグループ
- Availability Zone 情報取得に利用する Lambda 関数
- IAM ロール

テンプレートから作成される IAM ロールは EC2 インスタンスおよび Lambda 関数でのみ利用され、EC2 リソースの情報取得を行うために利用します。
許可されているアクションは AWS の仕様上、アカウントに存在する他の EC2 リソースの情報も閲覧できる設定になっていますが、主催者は不要な情報の取得はいたしません。

### 2. テンプレートでのスタックの作成

1. [AWS マネジメントコンソールの CloudFormation](https://ap-northeast-1.console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/) を開き、右上が「東京」(アジアパシフィック (東京) ap-northeast-1)になっていることを確認します。
2. 「スタックの作成」をクリックします。
   - 既存のスタックがある場合は「スタックの作成」から「新しいリソースを使用（標準）」を選択します。
3. "スタックの作成" ページから「テンプレートの準備完了」、「テンプレートファイルのアップロード」を選択し、ダウンロードしたテンプレートのアップロードを行なった後に「次へ」をクリックします。
4. "ステップ 2 スタックの詳細を指定" では任意のスタック名を設定し、「次へ」をクリックします。
5. 以降は変更を行わず画面にしたがって進めますが、"ステップ 4 レビュー" において「スタックの作成」の上に表示されている「AWS CloudFormation によって IAM リソースが作成される場合があることを承認します。」にチェックを入れた上で、「スタックの作成」をクリックします。

TODO: テンプレートを使った AWS CloudFormation での作成手順を確認

スタックは複数作成することが可能です。スタックを複数作成した場合、ポータルには最後に作成されたスタックが登録されることになります。主催者はポータルに登録された環境以外のサポートは行いません。詳しくは下記 [競技環境の確認](#競技環境の確認) を参照してください。


#### 競技環境の再構築方法

選手自らが設定変更等により競技環境を破壊し復旧できなくなった場合や、検証環境が必要になった場合は、上記「テンプレートでのスタックの作成」を参考に選手自らが AWS CloudFormation で新たに競技環境の構築を行うことになります。再構築の際は、 AWS CloudFormation で既存のスタックとは異なる名前で新しいスタックを作成してください。新規競技環境は競技開始時点の初期状態となります。古い競技環境上で変更を加えたソースコードや設定ファイル等の移行が必要な場合は、各チームの責任で行ってください。

TODO: 再構築手順を実際に確認（スタック名の変更は必要か、ポータル側が上書きされているか、古い競技環境を消さないとチェックスクリプトがどうなるか、etc...）

#### 競技環境の確認

サーバー起動（再起動）時に競技環境が主催者の指定した環境で構築されているかを確認し、環境情報をポータルに送信する処理が実行されます。
この処理はサーバー起動（再起動）を行うたびにポータルへ環境情報が送信されるため、 AWS CloudFormation で新たに競技環境の構築を行った際にもポータル上の情報が上書きされます。
また、選手自らがサーバーの起動（再起動）を行った際にも環境情報を確認し、ポータルに送信する処理が実行されるため、サーバーの起動（再起動）の際にはポータルの環境情報が上書きされることに留意してください。

競技環境の確認は以下のコマンドで選手自らが行うことも可能です。

```
$ /opt/isucon-env-checker/isucon-env-checker
```

##### 環境確認に使うファイル

環境確認には下記のファイルを利用します。環境確認が正常に行われるために下記のファイルには変更を加えてはいけません。

| File                                                | 説明                                                                               |
|-----------------------------------------------------|-----------------------------------------------------------------------------------|
| `/etc/systemd/system/isucon-env-checker.service`    | サーバー起動時に起動され `run-isucon-env-checker.sh` を実行                            |
| `/opt/isucon-env-checker/run-isucon-env-checker.sh` | ランダムな秒数(0 ~ 14 秒)待った後に `/opt/isucon-env-checker/isucon-env-checker` を実行 |
| `/opt/isucon-env-checker/isucon-env-checker`        | 競技環境の確認、環境情報をポータルへ送信                                                 |


### 3. インスタンスへの SSH

スタックの作成後、5分程度でインスタンスが起動し GitHub に登録している SSH 鍵によりインスタンスへ SSH ができるようになります。
インスタンスにはユーザー名 `isucon` で SSH を行います。

[ssh_config](https://man.openbsd.org/ssh_config.5) の例を以下に示します。なお、あくまで例示であり必ず以下の設定を利用する必要はありません。

```
 Host isucon-server1
   HostName <Elastic IPアドレス 1>
   User isucon

Host isucon-server2
   HostName <Elastic IPアドレス 2>
   User isucon

Host isucon-server3
   HostName <Elastic IPアドレス 3>
   User isucon
```

### 重要事項

- **競技に利用できる計算機資源は主催者が公開した上記の所定手順で起動された EC2 インスタンスのみです。**
  - テンプレートで作成されたリソースに対して、変更（AMIやインスタンスタイプの変更など）を行うことは禁止行為にあたり失格となります。
  - 競技終了時点で競技環境確認に失敗した場合や、ポータル上の環境情報に複数環境 (スタック)が混在した状態の場合失格となります。
  - 特例として外部のメトリクス計測サービスの使用のみ許可をしますが、スコアを向上させるいかなる効果も持つものであってはいけません。
- **競技終了後は、負荷走行成績の追試を行います。Discord サーバー および http://isucon.net/ にて主催者からお知らせをするまで、サーバーの操作はしないでください。**
  - 競技終了後の作業は禁止行為にあたり失格となります。
- **サーバー上の `isucon` 以外のユーザに関して、ユーザ削除や既存の公開鍵の削除、その他 sshd の設定変更等を行ったことにより、主催者による追試をおこなうことができない場合は、失格とします。**

## 作業手順

以下の順序で作業を開始してください。

### 1. サーバーへのログイン

[インスタンスへの SSH](#3-インスタンスへの-ssh) に示した三台のサーバーのいずれかに対して SSH 接続してください。
ログインには参加登録に利用した ( = ポータルのログインに利用している) GitHub アカウントに登録されている SSH 鍵を利用します。

SSH ログインのユーザ名は `isucon` です。

### 2. アプリケーションの動作確認

#### 2.1 ブラウザからの ISUCONDITION の動作確認

初期状態ではサーバーの Elastic IP アドレスに、Web ブラウザから HTTPS で `GET /` へアクセスするとアプリケーションが表示されます。
サーバーの Elastic IP アドレスにアクセスすると TLS 証明書の検証エラーが表示されますが、このエラーを回避するにはサーバーの Elastic IP アドレスが `54.150.88.xx` だった場合、Mac や Linux であれば `/etc/hosts` に Windows であれば `C:\Windows\System32\drivers\etc\hosts` に以下の行を追加する必要があります。

例:
```
54.150.88.xx isucondition.t.isucon.dev
```

ログインには Japan ISU Association（以下 JIA）のアカウントが必要です。
下記の 4 ユーザが登録されているので、動作確認にご利用ください。

| ログイン ID | パスワード   | 備考      |
|------------|------------|----------|
| isucon     | isucon     | 初期ユーザ |
| isucon1    | isucon1    | 初期ユーザ |
| isucon2    | isucon2    | 初期ユーザ |
| isucon3    | isucon3    | 初期ユーザ |


上記のうち `isucon` ユーザはベンチマーカーがユーザとして実行するアカウントでもあり、負荷走行後のアプリケーションの状態確認に利用することが可能です。


ISU の登録には JIA が管理する JIA ISU ID が必要となります。
アプリケーションの動作確認には以下の JIA ISU ID が登録されており利用することができますが、下2つの JIA ISU ID は `isucon` ユーザが初期状態で利用を行っており ISU の登録済みの状態確認に利用することができます。

| JIA ISU ID                           | 登録ユーザ |
|--------------------------------------|----------|
| 3a8ae675-3702-45b5-b1eb-1e56e96738ea |          |
| 3efff0fa-75bc-4e3c-8c9d-ebfa89ecd15e |          |
| f67fcb64-f91c-4e7b-a48d-ddf1164194d0 |          |
| 32d1c708-e6ef-49d0-8ca9-4fd51844dcc8 |          |
| af64735c-667a-4d95-a75e-22d0c76083e0 |          |
| cb68f47f-25ef-46ec-965b-d72d9328160f |          |
| 57d600ef-15b4-43bc-ab79-6399fab5c497 |          |
| aa0844e6-812d-41d2-908a-eeb82a50b627 |          |
| 0694e4d7-dfce-4aec-b7ca-887ac42cfb8f | isucon   |
| f012233f-c50e-4349-9473-95681becff1e | isucon   |

ISU を登録すると、 JIA API Mock  (Japan ISU Association のサービスと ISU の動きを模した開発用モック)から設定した URL に対してコンディションの送信が開始されます。

#### 2.2 コンソールからの ISUCONDITION の動作確認

JIA からトークンを取得し、ISUCONDITION へ取得したトークンを使いログインを行い、cookie の設定を行うことで、コンソールからも ISUCONDITION の動作確認が可能です。
以下、コンソールからの動作確認方法の一例を示します。

##### JIA API からの トークンの取得

```
$ TOKEN=`curl -sf -H 'content-type: application/json' http://<Elastic IP アドレス>:5000/api/auth -d '{"user": "isucon", "password": "isucon"}'`
```

JIA API に送信する `user` と `password` には、 [2.1 ブラウザからの ISUCONDITION の動作確認](#21-ブラウザからの-isucondition-の動作確認) に記載されているものを用いてください。
JIA API から発行されるトークンの有効期限は、発行から30分となります。

#####  トークンを使った cookie の設定

```
$ curl -c cookie.txt -vf -XPOST -H "authorization: Bearer ${TOKEN}" https://<Elastic IP アドレス>/api/auth
```

一例として、cookie を使い `GET /api/isu` にアクセスします。

```
$ curl -b cookie.txt https://<Elastic IP アドレス>/api/isu
```

##### ISU からのコンディションを受け取る `POST /api/condition/:jia_isu_uuid` の検証

ISU からのコンディションを受け取る `POST /api/condition/:jia_isu_uuid` は、 
アクティベートを行った ISU であれば、以下のようにコンソールからもコンディションを受け取ることが可能です。
JIA ISU ID は、[2.1 ブラウザからの ISUCONDITION の動作確認](#21-ブラウザからの-isucondition-の動作確認) に記載されているものを利用してください。 

```
$ export JIA_ISU_UUID=0694e4d7-dfce-4aec-b7ca-887ac42cfb8f
$ curl -XPOST -H 'content-type: application/json' https://<Elastic IP アドレス>/api/condition/${JIA_ISU_UUID} \
-d '[{"is_sitting": true, "condition": "is_dirty=true,is_overweight=true,is_broken=true","message":"test","timestamp": 1628492991}]'
```

### 3. 負荷走行 (ベンチマーク)

負荷走行はポータルサイト上からリクエストします。
ポータルサイトの [ISUCON11 Contestant](https://portal.isucon.net/contestant) にアクセスし、 "Job Enqueue Form" から負荷走行対象のサーバーを選択、"Enqueue" をクリックすることで負荷走行のリクエストが行われ、順次開始されます。

なお、負荷走行が待機中 (PENDING) もしくは実行中 (RUNNING) の間は追加の Enqueue を行うことはできません。

### JIA API Mock　について

JIA API Mock は、ISUCONDITION の開発用に用いられる JIA の API モックとして、サーバーのポート 5000 番で待ち受けます。
JIA API Mock は以下のエンドポイントと、 ISU からのコンディション送信を模擬したリクエストを送る機能を持っています。

- `GET /` - ブラウザから JIA へのログイン動作を確認するための画面を表示
- `POST /api/auth` - ISUCONDITION へログインするためのトークンの発行
- `POST /api/activate` - ISU の登録（アクティベート）
- 登録した ISU から ISUCONDITION へ向けたコンディションの送信

- JIA のログインページ
  - `http://<Elastic IP アドレス>:5000/`

JIA API のエンドポイント仕様は [ISUCONDITION アプリケーションマニュアル](./isucondition.md)を参照してください。

JIA API Mock は ISU を登録（アクティベート）すると、指定された URL へのコンディションの送信を開始します。
登録したISUからのコンディション送信は JIA API Mock を停止/再起動するまで続きますので、負荷走行前には JIA API Mock を停止/再起動することをお勧めします。
JIA API Mock のサービスを停止/再起動する場合は、 以下のコマンドを利用してください。

```shell
$ sudo systemctl [stop|restart] jiaapi-mock.service
```

負荷走行後の ISUCONDITION はベンチマーカーが設定した JIA のエンドポイントが設定されているため、ISUCONDITIONから `500 Internal Server Error` が返されるエンドポイントがあります。
負荷走行後に JIA API Mock を利用する際は、下記のように `POST /initialize` で JIA API Mock のエンドポイントを設定してください。ただし `POST /initialize` は下記 "データベースの初期化方法" にも記載があるように、データベース内のデータを初期化することに留意してください。

```
curl -sf -H 'content-type: application/json' https://<Elastic IP アドレス 1,2,3>/initialize -d '{"jia_service_url": "http://localhost:5000"}'
```

#### JIA API Mock の URL 設定

負荷走行後の ISUCONDITION はベンチマーカーが設定した JIA のエンドポイントが設定されているため、上記の設定を行っていても ISUCONDITIONから `500 Internal Server Error` が返されるエンドポイントがあります。
負荷走行後に JIA API Mock を利用する際は、下記のように `POST /initialize` で JIA API Moc のエンドポイントを設定してください。

```
curl -sf -H 'content-type: application/json' https://<Elastic IP アドレス>/initialize -d '{"jia_service_url": "http://<Elastic IP アドレス>:5000"}'
```

#### JIA API Mock を用いたローカルでの開発方法

ローカル環境で開発している ISUCONDITION に対して JIA API Mock を利用した検証を行うためには、サーバー上の 5000 番ポートで待ち受けている JIA API Mock へアクセスできるようにするため、ポートフォワーディングが必要です。

以下に [SSH におけるローカルポートフォワーディング](https://help.ubuntu.com/community/SSH/OpenSSH/PortForwarding#Local_Port_Forwarding) を実行するコマンドを例示します。
これは「リモートホスト `isucon-server1` に SSH 接続をした上で」「ローカルの `localhost:5000` への TCP 接続を」「リモートホストを通して `isucondition-1.t.isucon.dev` へ転送する」というコマンドです。

```shell
$ ssh -L localhost:5000:isucondition-1.t.isucon.dev:5000 isucon-server1
```

上記のローカルポートフォワーディングの設定を行った場合、ログインや ISU の登録（アクティベート）の機能は利用可能となりますが、登録した ISU からローカル環境で開発している ISUCONDITION へ向けたコンディションの送信はできません。[ISU からのコンディションを受け取る `POST /api/condition/:jia_isu_uuid` の検証](#isu-からのコンディションを受け取る-post-apiconditionjia_isu_uuid-の検証) を参考に、コンソールから ISU のコンディション送信を行った検証を行ってください。


### データベースの初期化方法

初期状態のアプリケーションでは、初期化処理（`POST /initialize`）においてデータベースを初期状態に戻します。
次のコマンドを実行してもデータベースを初期状態に戻すことができます。

```
$ ~isucon/webapp/sql/init.sh
```

### 参考実装

下記の言語での実装が提供されています。

- Go
- Node.js
- Perl
- PHP
- Python
- Ruby
- Rust

### 参考実装の切り替え方法

初期状態では Go による実装が起動しています。

各言語実装は systemd で管理されています。
例えば、参考実装を Go から Ruby に切り替えるには次のようにします。

```shell
sudo systemctl disable --now isucondition.go.service

sudo systemctl enable --now isucondition.ruby.service
```

### `/etc/hosts` ならびに `isucondition-[1-3].t.isucon.dev` ドメインについて

サーバーには初期状態で、割り当てられている 3 台のサーバーの IP アドレスが事前に `/etc/hosts` へ登録されています。これらのホスト名は自由に利用して構いません (これを利用しなくても構いません)

例:

```
192.168.0.11 isucondition-1.t.isucon.dev
192.168.0.12 isucondition-2.t.isucon.dev
192.168.0.13 isucondition-3.t.isucon.dev
```

`*.t.isucon.dev` の FQDN に関しては `127.0.0.1` (IPv6 は `::1`) の DNS レコードが登録されています。また、サーバーに配置されている TLS 証明書は subject name が `*.t.isucon.dev` であるため、この名前であれば TLS 証明書の検証が通る状態で HTTPS 接続等を行うことができるようになっています。

ベンチマーカーには `192.168.0.11`,`192.168.0.12`,`192.168.0.13` ではなく Elastic IP アドレスを利用した `/etc/hosts` エントリが登録されています。負荷走行の際は、ベンチマーカーより負荷走行の対象となるサーバーに対応する `isucondition-1` ~ `isucondition-3.t.isucon.dev` のホスト名を利用した HTTPS 接続が行われます。その際、TLS 証明書検証が通る必要がある旨、留意してください。

### 時計について

主催者が管理するベンチマーカーについては、Amazon Time Sync Service (169.254.169.123) と systemd-timesyncd を利用して時刻同期が設定されています。

選手へ提供されるサーバーについても、初期状態で同様の設定がされています。

### ISU の仮想時間について

ベンチマーカーが模す ISU の世界では現実の3万倍の速度で時間が流れており(現実の1秒がISU世界では30,000秒)、ISU はこの仮想時間を使ったデータを送信します。

## 負荷走行について

ベンチマーカーによる負荷走行は以下のように実施されます。

1. 初期化処理の実行 `POST /initialize` (20 秒でタイムアウト)
2. アプリケーション互換性チェック (数秒～数十秒)
3. 負荷走行 (60 秒)

初期化処理は 20 秒以内に完了する必要があります。これを超えた場合、負荷走行は失敗になります。
ベンチマーカーはアプリケーション互換性チェックのために意図的に `4xx` のレスポンスステータスコードを期待するリクエストを投げることがあります。
アプリケーション互換性チェックが通らなかった場合、その負荷走行は失敗となります。

### リダイレクトについて

ベンチマーカーはリクエストに対してリダイレクトレスポンススコード (301, 302, 303, 307, 308) を返された場合、、[Location](https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Location) ヘッダーで指定された URL ページへの**リダイレクトを行いません。**
ベンチマーカーはレスポンスとして `30x` が送られたことだけを認識します。

### キャッシュについて

アプリケーションは「[`POST /api/condition/:jia_isu_uuid` の反映について](#post-apiconditionjia_isu_uuid-の反映について)」に基づいてキャッシュを返すことが認められています。
それ以外については、データの更新が即時反映されていることを期待してベンチマーカーは検証を行います。ただし、ベンチマーカーが検知しない限りは古い情報を返しても構いません。

なお、キャッシュを用いた場合に、加点の機会が減る可能性に留意してください（[スコア計算](#スコア計算)を参照）]

#### `POST /api/condition/:jia_isu_uuid` の反映について

`POST /api/condition:jia_isu_uuid` で受け取ったコンディションの反映が遅れることについて、ベンチマーカーは許容しています。
以下のエンドポイントが該当します。
	
- `GET /api/isu`
- `GET /api/isu/:jia_isu_uuid/graph`
- `GET /api/condition/:jia_isu_uuid`
- `GET /api/trend`

ただし、ベンチマーカーは、あるエンドポイントで一度取得したコンディションは、以降もそのエンドポイントで取得できることを期待しています。
また、`GET /api/condition/:jia_isu_uuid` と `GET /api/isu/:jia_isu_uuid/graph` については以下の条件を期待してベンチマーカーは検証を行います
 
 - `GET /api/condition/:jia_isu_uuid` で取得できたコンディションは、 1 秒後には`GET /api/isu/:jia_isu_uuid/graph` でも取得できる。
 - `GET /api/isu/:jia_isu_uuid/graph` で取得できたコンディションは、 1 秒後には `GET /api/isu/:jia_isu_uuid` でも取得できる。

なお、反映を遅らせた場合、加点の機会が減る可能性に留意してください（[スコア計算](#スコア計算)を参照）]

#### Conditional GET のサポートについて

ベンチマーカーは一般的なブラウザの挙動を模した [Conditional GET](https://tools.ietf.org/html/rfc7232) に対応しています。
アプリケーションは、 `Cache-Control` やその他必要なレスポンスヘッダを返すことで、ベンチマーカーから Conditional GET リクエストを受けることができます。
データが更新されていないことが期待されるリクエストにおいては、`304 Not Modified` を返したり、あるいはブラウザのキャッシュ有効期限の制御によってリクエストが発生していない場合も、ベンチマーカーはそれらのキャッシュを利用してレスポンスがあったものとみなします。

なお、ベンチマーカー内のユーザは独立しているため、 `Cache-Control: public` 等が指定されていたとしても、ユーザ同士でキャッシュを共有することはありません。

### タイムアウトについて

ToDo: ベンチと確認&意識合わせ
ベンチマーカーにおいて設定されているタイムアウト値は下記の通りです。

- `POST /initialize`
  - 20 秒以内にレスポンスを返す必要があります。これを超えた場合、負荷走行は即時失敗します。
- `POST /api/condition/:jia_isu_uuid`
  - 100 ミリ秒を超えるとタイムアウトしますが、後述のスコア計算にあるように減点の対象とはなりません。
- 上記以外の HTTP リクエスト
  - 1 秒以内にレスポンスを返す必要があります。これを超えた場合、後述のスコア計算に従い減点の対象となります。
  - ベンチマーカーが管理する 1 ユーザのタイムアウトが 20 回を超えると、ベンチマーカーは新規のユーザや閲覧者の追加を行わずに負荷走行を継続します。

なお、負荷走行終了時点でレスポンスを返していないリクエストについては強制的に切断され、上記のタイムアウト時間にかかわらずタイムアウトとして処理されますが、減点の対象とはなりません。

### 負荷走行終了後に起こる DB の高負荷状態の解消について

負荷走行終了後にDBの高負荷状態が続くことがあります。
これはアプリケーションから DB へのクエリが継続している場合があります。

DB への高負荷状態を解消するためには以下のように動作中の ISUCONDITION サービスを再起動してください。

MEMO: MariaDBの再起動でも行けるか確認

```
sudo systemctl restart isucondition.go
```

## スコア計算

負荷走行のスコアは下記の加点と減点から算出されます。

### 負荷走行時における加点について

スコアはユーザが下記のように ISU のコンディションやグラフを確認することで加点されます。

- ISU のコンディション確認 (`GET /api/condition/:jia_isu_uuid`) でユーザが新しく確認できた ISU のコンディションとその数に応じた加点(過去に確認済みのコンディションでは加点されません)
  - Info (50 点)
  - Warning (20 点)
  - Critical (10 点)
- ISU のグラフ確認(`GET /api/isu/:jia_isu_uuid/graph`)でユーザがまだ確認していないグラフの確認に成功した時、確認したグラフを構成するデータに応じた得点を加点（後述）
  - 過去のグラフは過去に見たことがある日付まで遡り、まだ見たことがないグラフを最初に確認したときに得点を加点。
  - コンディションが送られてきている当日のグラフは、前回のグラフ確認からグラフを構成するデータが増えていることを確認した場合、再度得点を加点。

#### グラフの確認による加点

グラフの確認による加点は、1日のグラフを構成する 1 時間毎のデータの中に含まれる最少のコンディション数 (n) に応じて下記の表を元に得点を加点します。
コンディションが送られてきている当日のグラフは、コンディションが送られてきている時間までで 1 時間毎のデータの中に含まれる最少のコンディション数 (n) を決定します。

| レベル    | 得点 | 条件         |
|-----------|------|--------------|
| Excellent | 200  | 30 <= n      |
| Good      | 150  | 20 <= n < 30 |
| Normal    | 100  | 10 <= n < 20 |
| Bad       | 60   | 5  <= n < 10 |
| Worst     | 10   | 0  <= n < 5  |

  - ToDo：上記の得点や条件は仮のもののため調整が終わり次第書き換える

### 負荷走行時における減点、即時失敗（fail) について

負荷走行時に発生するエラーによっては、減点や即時失敗（fail）となります。条件は以下の通りです。

- アプリケーション互換性チェック、もしくはデータ整合性チェックに失敗した
  - 1 回あたり減点 1 点
  - 100 回の失敗時点で即時失敗とする

- リクエストがタイムアウトした場合 (条件は前項に記載)
  - 10 回あたり減点 1 点
  - 即時失敗は無し

- `POST /api/condition/:jia_isu_uuid` は上記の減点に該当せず、一切の減点を行いません。

## 最終スコア

競技時間終了後、再起動後に主催者によって実行された負荷走行のスコアを最終スコアとします。

### 制約事項

以下の事項に抵触すると失格 (fail) となり、点数が 0 点になります。

- `POST /initialize` へのレスポンスを 20 秒以内に返さない場合
- 負荷走行前のアプリケーション互換性チェックに失敗した場合
- 負荷走行中のアプリケーション互換性チェック、もしくはデータ整合性チェックに 100 回失敗した
- その他、ベンチマーカーが失敗を検出したケース

最初に呼ばれる初期化処理 `POST /initialize` は用意された環境内で、チェッカツールが要求する範囲の整合性を担保します。
サーバーサイドで処理の変更・データ構造の変更などを行う場合、この処理が行っている内容を漏れなく提供してください。

予選終了後に行われる主催者による確認作業 （追試） において下記の点が確認できなかった場合は失格となります。

- アプリケーションは全保存データを永続化していること
  - 負荷走行実施後に再起動が行われた場合、直前まで行われていた内容が保存されている必要があります
- アプリケーションはブラウザ上での表示を初期状態と同様に保っていること

### `POST /initialize` での実装言語の出力

`POST /initialize` レスポンスにて、本競技で利用した言語を出力してください。 集計し [blog](https://isucon.net/) での公表や、参考情報として利用させていただきます。

`POST /initialize` のレスポンスは次のような JSON 形式となります。

```
{
    "language": "実装言語"
}
```

language の値が実装に利用した言語となります。 language が空の場合はベンチマーカーに失敗と見なされます。

# レギュレーション

## ソフトウェア事項

選手は主催者から Web アプリケーション (問題) が与えられ、選手は競技時間内にその Web アプリケーションの高速化を行う。
選手は高速化された実装 (回答) を作成する時、主催者より与えられたソフトウェア (初期実装) をベースに実装しても良いし、しなくても良い。
下記の環境に記載されているプログラミング言語で初期実装が提供されるが、その各々の性能が一致することは保証されない。

提供される初期実装
- Go
- Node.js
- Perl
- PHP
- Python
- Ruby
- Rust

高速化の際、主催者より問題として与えられた Web アプリケーションから、以下の部分は変更しないこと。

- アクセス先の URI、ただしサーバー側で生成する部分（ID など）は文字種（[0-9] や [0-9a-zA-Z_] など）を変えない範囲で自由に生成しても良い
- レスポンス (HTML の DOM, JSON オブジェクト等) の構造
- JavaScript/CSS ファイルの内容
- 画像および動画等のメディアファイルの内容

各サーバーにおけるソフトウェアの入れ替え、設定の変更、アプリケーションコードの変更および入れ替えなどは一切禁止しない。
負荷走行中にポータル・マニュアル・レギュレーションといった、主催者の指示以外で利用が認められたサーバー以外の外部リソースを使用する行為(他のインスタンスに処理を委譲するなど) は禁止する。 ただしモニタリングやテスト、開発などにおいては、PC や外部のサーバーを利用しても構わない。

許可される事項には、例として以下のような作業が含まれる。

- 複数台あるサーバーの役割の変更
- データベーススキーマの変更やインデックスの作成・削除
- データベースに利用するミドルウェアの変更
- キャッシュ機構の追加、ジョブキュー機構の追加による遅延書き込み
- 他の言語による再実装

ただし以下の事項に留意すること。

- サーバー再起動後にすべてのアプリケーションコードが正常動作する状態を維持すること
- 負荷走行実行時にアプリケーションに書き込まれたデータは再起動後にも取得できること

## 禁止事項

以下の行為を特に禁止する。

- 競技終了時間までに、競技の内容に関するあらゆる事項 (問題内容・計測ツールの計測方法など)を公開・共有すること(内容を推察できる発言も含む)
  - 不特定多数への公開はもちろん、他チームの選手と連絡を取り、問題内容等を共有する事 (結託行為) も禁止とする。
  - ただし主催者が Twitter, Web サイトにおいて公開している情報は除く。ポータルでログインを要するページにおいて記載されている内容は公開情報でない旨留意すること。
- 競技時間中、チーム外の人物と ISUCON11 問題にまつわる事項のやりとり (ISUCON11 選手であるかどうかを問わない、SNS での発言も含む)
- 主催者の指示以外で利用が認められたサーバー以外の外部リソースを使用する行為(他のインスタンスに処理を委譲するなど) は禁止する。
  - ただしモニタリングやテスト、開発などにおいては、PCや外部のサーバーを利用しても構わない。
- 選手が主催者からその選手が属するチームへ提供されていないサーバーについて直接のアクセスを試みる行為や、外部への不正アクセスを試みる行為。具体的にはベンチマーカーへのログイン試行等。(なお、例示のため、これに限らない。)
- 他チームと結託する行為 (程度を問わず)
- 主催者が他チームへの妨害、競技への支障となるとみなす全ての行為


本マニュアルやレギュレーション, ポータルサイトにおいて禁止とされた行為 (禁止事項) への違反は、失格となる。
